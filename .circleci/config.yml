# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference

version: 2
jobs:
  build:
    docker:
    - image: circleci/php:7.4.3
    - image: circleci/mysql:5.7.21
      environment:
        MYSQL_DATABASE: quizGame
        MYSQL_ROOT: root

    steps:
    - checkout

    - run: sudo apt update
    - run: sudo docker-php-ext-install pdo_mysql
    - run: sudo docker-php-ext-enable pdo_mysql
    - run: sudo wget https://get.symfony.com/cli/installer -O - | bash
    - run: sudo mv /home/circleci/.symfony/bin/symfony /usr/local/bin/symfony

    - run:
        command: composer install
        working_directory: ./
    - run:
        command: php bin/console cache:clear --env=prod
        working_directory: ./
    - run:
        command: php bin/console cache:clear
        working_directory: ./
    - run:
        command: yes | php bin/console doctrine:migrations:migrate || true
        working_directory: ./
    - run:
        command: yes | php bin/console doctrine:fixtures:load || true
        working_directory: ./
    - run:
        command: symfony server:start -d
        working_directory: ./
    - run:
        command: php bin/phpunit
        working_directory: ./
    - run:
        command: symfony server:stop
        working_directory: ./
